<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>{% if edit_mode %}Editar Ficha{% else %}Toques Finais — Criação de Ficha{% endif %}</title>
<style>
  :root{ --bg:#0d0f14; --card:#161b24; --accent:#d4af37; --muted:#aeb3b8; --panel:#1c2330; }
  body{background:var(--bg); color:#f5f5f5; font-family:"Segoe UI",Roboto,Arial; margin:0; padding:22px;}
  .container{max-width:1100px; margin:20px auto;}
  .card{background:var(--card); padding:18px; border-radius:12px; margin-bottom:18px; border-left:6px solid var(--accent);}
  label{display:block; font-size:14px; color:var(--muted); margin-bottom:6px;}
  input[type="text"], input[type="number"], textarea{width:100%; padding:10px; border-radius:8px; border:1px solid rgba(255,255,255,0.03); background:#0f1318; color:#fff;}
  textarea{min-height:110px;}
  .controls{display:flex; gap:12px; margin-top:12px; align-items:center; flex-wrap:wrap;}
  .btn{background:var(--accent); color:#141820; border:none; padding:8px 12px; border-radius:8px; cursor:pointer; font-weight:700;}
  .ghost{background:transparent; border:1px solid rgba(212,175,55,0.15); color:var(--accent);}
  .grid{display:grid; grid-template-columns: 1fr 320px; gap:18px;}
  @media(max-width:980px){ .grid{grid-template-columns:1fr; } }
  .pill {display:inline-block;padding:6px 10px;border-radius:999px;background:#0f1318;border:1px solid rgba(255,255,255,0.03);cursor:pointer;margin:6px 6px 6px 0;}
  .pill.active{background:var(--accent); color:#141820;}
  .list-scroll{max-height:240px; overflow:auto; padding-right:6px;}
  .points{font-weight:800; font-size:22px; color:var(--accent);}
  .meta{font-size:13px; color:var(--muted); margin-top:8px;}
</style>
</head>
<body>
<div class="container">
  <div class="card">
    <h1 style="margin:0; color:var(--accent)">{% if edit_mode %}Editar Ficha{% else %}Toques Finais — Criação de Ficha{% endif %}</h1>
    <div class="meta">Escolha perícias, vantagens e desvantagens. Pontos atualizam em tempo real.</div>
  </div>

  <form id="finalForm" method="POST" action="{% if edit_mode %}{{ url_for('editar_ficha', id=ficha.id) }}{% else %}{{ url_for('criar_ficha_final') }}{% endif %}">
    <div class="grid">
      <div>
        <div class="card">
          <label>Nome do Personagem</label>
          <input type="text" name="nome" id="nome" value="{{ ficha.nome if ficha and ficha.nome is defined else '' }}" required>
          <label style="margin-top:10px">Idade</label>
          <input type="number" name="idade" id="idade" value="{{ ficha.idade if ficha and ficha.idade is defined else '' }}" min="0">
          <div style="margin-top:12px; display:flex; gap:10px;">
            <div>
      <div class="card">
  <h3 style="color:var(--accent)">Atributos</h3>
  <div class="attr-grid">
      <div>
      <label>Poder (P)</label>
      <input type="number" id="attrP" name="poder" min="0" max="10" value="{{ ficha.poder or 0 }}">
    </div>
    <div>
      <label>Habilidade (H)</label>
      <input type="number" id="attrH" name="habilidade" min="0" max="10" value="{{ ficha.habilidade or 0 }}">
    </div>
    <div>
      <label>Resistência (R)</label>
      <input type="number" id="attrR" name="resistencia" min="0" max="10" value="{{ ficha.resistencia or 0 }}">
    </div>
  </div>
      </div>                  
            
        <div class="card">
          <h3 style="margin:0 0 8px 0; color:var(--accent)">Perícias (1 pt)</h3>
          <div class="list-scroll" id="periciasWrap"></div>
        </div>

        <div class="card">
          <h3 style="margin:0 0 8px 0; color:var(--accent)">Vantagens</h3>
          <div class="list-scroll" id="vantagensWrap"></div>
        </div>

        <div class="card">
          <h3 style="margin:0 0 8px 0; color:var(--accent)">Desvantagens (valem pontos)</h3>
          <div class="list-scroll" id="desvWrap"></div>
        </div>

        <div class="card">
          <h3 style="margin:0 0 8px 0; color:var(--accent)">Histórico / Notas</h3>
          <textarea name="historico" id="historico">{{ ficha.historico if ficha and ficha.historico is defined else '' }}</textarea>
        </div>

      </div>

      <aside>
        <div class="card">
          <label>Pontos iniciais</label>
          <input type="number" id="initialPoints" value="10" min="0" />
          <div style="margin-top:10px"><div class="meta">Perícias: <span id="periciasCost">0</span> pts</div></div>
          <div style="margin-top:10px"><div class="meta">Vantagens: <span id="vantCost">0</span> pts</div></div>
          <div style="margin-top:10px"><div class="meta">Desvantagens (ganho): <span id="desvGain">0</span> pts</div></div>

          <hr style="margin:12px 0; border-top:1px solid rgba(255,255,255,0.03)" />

          <div class="meta">Pontos Restantes</div>
          <div class="points" id="pointsLeft">10</div>

          <div style="margin-top:12px" class="controls">
            <button type="button" class="btn" onclick="prepareSubmit()">{% if edit_mode %}Salvar Alterações{% else %}Visualizar / Salvar{% endif %}</button>
            <button type="button" class="btn ghost" onclick="resetSelections()">Limpar</button>
            <a class="btn ghost" href="{{ url_for('fichas') }}">Cancelar</a>
          </div>

          <div class="meta" style="margin-top:10px">Perícia = 1pt. Vantagens têm custos variados. Desvantagens adicionam pontos (até -2 acumulado).</div>
        </div>
      </aside>
    </div>

    <input type="hidden" name="pericias" id="periciasHidden" value="{{ ficha.pericias if ficha and ficha.pericias is defined else '' }}">
    <input type="hidden" name="vantagens" id="vantagensHidden" value="{{ ficha.vantagens if ficha and ficha.vantagens is defined else '' }}">
    <input type="hidden" name="desvantagens" id="desvantagensHidden" value="{{ ficha.desvantagens if ficha and ficha.desvantagens is defined else '' }}">
  </form>
</div>

<script>
const pericias = ["Animais","Arte","Esportes","Influência","Luta","Manha","Máquinas","Medicina","Mística","Percepção","Saber","Sobrevivência"];
const vantagens = [
  {k:"Aceleração", l:"Aceleração (1pt)", c:1},
  {k:"+Ação", l:"+Ação (1pt)", c:1},
  {k:"Acumulador", l:"Acululador (1pt)", c:1},
  {k:"Agil", l:"Ágil (1pt)", c:1},
  {k:"Ajudante", l:"Ajudante (1pt)", c:1},
  {k:"Alcance 1", l:"Alcance 1 (1pt)", c:1},
  {k:"Alcance 2", l:"Alcance 2 (2pt)", c:2},
  {k:"Anulação", l:"Anulação (2pts)", c:2},
  {k:"Arena", l:"Arena (1pt)", c:1},
  {k:"Ataque Eapecial (Área)", l:"Ataque Especial (Área) (1pt)", c:1},
  {k:"Ataque Eapecial (Choque)", l:"Ataque Especial (Choque) (1pt)", c:1},
  {k:"Ataque Eapecial (Distante)", l:"Ataque Especial (Distante) (1pt)", c:1},
  {k:"Ataque Eapecial (Espiritual)", l:"Ataque Especial (Espiritual) (1pt)", c:1},
  {k:"Ataque Eapecial (Investida)", l:"Ataque Especial (Investida) (1pt)", c:1},
  {k:"Ataque Eapecial (Múltiplo)", l:"Ataque Especial (Múltiplo) (1pt)", c:1},
  {k:"Ataque Eapecial (Penetrante)", l:"Ataque Especial (Penetrante) (1pt)", c:1},
  {k:"Ataque Eapecial (Perigoso)", l:"Ataque Especial (Perigoso) (1pt)", c:1},
  {k:"Ataque Eapecial (Poderoso)", l:"Ataque Especial (Poderoso) (1pt)", c:1},
  {k:"Ataque Eapecial (Potente)", l:"Ataque Especial (Potente) (1pt)", c:1},
  {k:"Ataque Eapecial (Preciso)", l:"Ataque Especial (Preciso) (1pt)", c:1},
  {k:"Ataque Eapecial (Titanico)", l:"Ataque Especial (Titanico) (1pt)", c:1},
  {k:"Base", l:"Base (1pt)", c:1},
  {k:"Brutal (Vida)", l:"Brutal (Vida) (1pt)", c:1},
  {k:"Brutal (Mana)", l:"Brutal (Mana) (1pt)", c:1},
  {k:"Brutal (Derrota)", l:"Brutal (Derrota) (1pt)", c:1},
  {k:"Carismático", l:"Carismático (1pt)", c:1},
  {k:"Clone", l:"Clone (1pt)", c:1},
  {k:"Confusão", l:"Confusão (1pt)",c:1},
  {k:"Cura", l:"Cura (1pt)", c:1},
  {k:"Defesa Especial (Blindada)", l:"Defesa Especial (Blindada) (1pt)", c:1},
  {k:"Defesa Especial (Esquiva)", l:"Defesa Especial (Esquiva) (1pt)", c:1},
  {k:"Defesa Especial (Proteção)", l:"Defesa Especial (Proteção) (1pt)", c:1},
  {k:"Defesa Especial (Provocação)", l:"Defesa Especial (Provocação) (1pt)", c:1},
  {k:"Defesa Especial (Reflexão)", l:"Defesa Especial (Reflexão) (1pt)", c:1},
  {k:"Defesa Especial (Robusta)", l:"Defesa Especial (Robusta) (1pt)", c:1},
  {k:"Defesa Especial (Tenaz)", l:"Defesa Especial (Tenaz) (1pt)", c:1},
  {k:"Defesa Especial (Titanica)", l:"Defesa Especial (Titanica) (1pt)", c:1},
  {k:"Desgaste", l:"Desagaste (1pt)", c:1},
  {k:"Devoto", l:"Devoto (1pt)", c:1},
  {k:"Elo Mental", l:"Elo Mental (1pt)", c:1},
  {k:"Estender", l:"Estenter (1pt)", c:1},
  {k:"Famoso", l:"Famoso (1pt)", c:1},
  {k:"Foco", l:"Foco (1pt)", c:1},
  {k:"Forte", l:"Forte (1pt)", c:1},
  {k:"Ilusão", l:"Ilusão (2pts)", c:1},
  {k:"Imitar", l:"Imitar (1pt)", c:1},
  {k:"Imortal", l:"Imortal (1pt)", c:1},
  {k:"Improviso", l:"Improviso (1pt)", c:1},
  {k:"Imune (Abíotico)", l:"Imune (Abíotico) (1pt)", c:1},
  {k:"Imune (Anfíbio)", l:"Imune (Anfíbio) (1pt)", c:1},
  {k:"Imune (Doenças)", l:"Imune (DOenças) (1pt)", c:1},
  {k:"Imune (Resiliente)", l:"Imune (Resiliente) (1pt)", c:1},
  {k:"Imune (Sem Mente)", l:"Imune (Sem Mente) (1pt)", c:1},
  {k:"Incorpóreo", l:"Incorpóreo (2pts)", c:2},
  {k:"Inimigo 1", l:"Inimigo (1pt)", c:1},
  {k:"Inimigo 2", l:"Inimigo (2pts)", c:2},
  {k:"Instrutor", l:"Instrutor (1pt)", c:1},
  {k:"Inofensivo", l:"Inofensivo (1pt)", c:1},
  {k:"Inventario 1", l:"Inventario 1 (1pt)", c:1},
  {k:"Inventario 2", l:"Inventario 2 (2pts)", c:2},
  {k:"Inventario 3", l:"Inventario 3 (3pts)", c:3},
  {k:"Invisivel 1", l:"Invisivel 1 (1pt)", c:1},
  {k:"Invisivel 2", l:"Invisivel 2 (2pts)", c:2},
  {k:"Irresistivel", l:"Irresistivel (1pt)", c:1},
  {k:"Maestria", l:"Maestria (1pt)", c:1},
  {k:"Magia", l:"Magia (2pts)", c:2},
  {k:"+Mana", l:"+Mana (1pt)", c:1},
  {k:"+Membros", l:"+Membros (2pts)", c:2},
  {k:"Mentor", l:"Mentor (1pt)", c:1},
  {k:"Obstinado", l:"Obstinado (1pt)", c:1},
  {k:"Paralisia", l:"Paralisia (1pt)", c:1},
  {k:"Patrono", l:"Patrono (1pt)", c:1},
  {k:"Punição", l:"Punição (1pt)", c:1},
  {k:"Punição", l:"Punição (2pts)", c:2},
  {k:"Regeneração 1", l:"Regeneração 1 (1pt)", c:1},
  {k:"Regeneração 2", l:"Regeneração 2 (2pts)", c:2},
  {k:"Resoluto", l:"Resoluto (1pt)", c:1},
  {k:"Riqueza 2", l:"Riqueza 1 (2pts)", c:2},
  {k:"Riqueza 4", l:"Riqueza 2 (4pts)", c:4},
  {k:"Riqueza 6", l:"Riqueza 3 (6pts)", c:6},
  {k:"Sentido (Aguçado)", l:"Sentido (Auçado (1pt)", c:1},
  {k:"Sentido (Infravisão)", l:"Sentido (Infravisão) (1pt)", c:1},
  {k:"Sentido (Intuição)", l:"Sentido (Intuição) (1pt)", c:1},
  {k:"Sentido (Radar)", l:"Sentido (Radar) (1pt)", c:1},
  {k:"Sentido (Raio X)", l:"Sentido (Raio X) (1pt)", c:1},
  {k:"Telepata", l:"Telepata (1pt)", c:1},
  {k:"Teleporte", l:"Teleporte (1pt)", c:1},
  {k:"Torcida", l:"Torcida (1pt)", c:1},
  {k:"Transormação", l:"Transformção (1pts)", c:1},
  {k:"Transormação", l:"Transformção (2pts)", c:2},
  {k:"+Vida", l:"+Vida (1pt)", c:1},
  {k:"Vigoroso", l:"Vigoroso (1pt)", c:1},
  {k:"Voo", l:"Voo (1pt)", c:1}
];
const desvantagens = [
  {k:"Ambiente", l:"Ambiente (–1pt)", g:1},
  {k:"Amnesia", l:"Amnésia (–2pt)", g:2},
  {k:"Antipatico", l:"Antipático (–1pt)", g:1},
  {k:"Assombrado", l:"Assombrado (-1pt)", g:1},
  {k:"Assombrado", l:"Assombrado (-2pts)", g:2},
  {k:"Atrapalhado", l:"Atrapalhado (-1pt)", g:1},
  {k:"Aura", l:"Aura (-1pt)", g:1},
  {k:"Aura", l:"Aura (-2pts)", g:2},
  {k:"Bateria", l:"Bateria (-1pt)", g:1},
  {k:"Código (1ª Lei de Asimov)", l:"Código (1ª Lei de Asimov) (-1pt)", g:1},
  {k:"Código (2ª Lei de Asimov)", l:"Código (2ª Lei de Asimov) (-1pt)", g:1},
  {k:"Código do Caçador", l:"Código do Caçador (-1pt)", g:1},
  {k:"Código do Combate", l:"Código do Combate (-1pt)", g:1},
  {k:"Código da Derrota", l:"Código da Derrota (-1pt)", g:1},
  {k:"Código da Gratidão", l:"Código da Gratidão (-1pt)", g:1},
  {k:"Código dos Heróis", l:"Código dos Heróis (-1pt)", g:1},
  {k:"Código da Honestidade", l:"Código da Honestidade (-1pt)", g:1},
  {k:"Código da Redenção", l:"Código da Redenção (-1pt)", g:1},
  {k:"Dependencia", l:"Depenencia (-2pts)", g:2},
  {k:"Diferente", l:"Diferente (-1pt)",g:1},
  {k:"Elo Vital", l:"Elo vital (-1pt)", g:1},
  {k:"Fracote", l:"Fracote (-1pt)", g:1},
  {k:"Frágil", l:"Frágil (-1pt)", g:1},
  {k:"Fraqueza", l:"Fraqueza (-1pt)", g:1},
  {k:"Fraqueza", l:"Fraqueza (-2pts)", g:2},
  {k:"Fúria", l:"Fúria (-1pt)", g:1},
  {k:"Pobreza", l:"Pobreza (–1pt)", g:1},
  {k:"Sem Vida", l:"Sem Vida (–2pt)", g:2},
  {k:"Tapado", l:"Tapado (–1pt)", g:1}
];

function buildPills(list, containerId, prefix, onClickExtra){
  const wrap = document.getElementById(containerId);
  wrap.innerHTML = "";
  list.forEach(item=>{
    const key = typeof item === 'string' ? item : (item.k || item);
    const label = typeof item === 'string' ? item : (item.l || item.k);
    const pill = document.createElement('button');
    pill.type = 'button';
    pill.className = 'pill';
    pill.dataset.key = key;
    pill.innerText = label;
    pill.addEventListener('click', ()=>{
      pill.classList.toggle('active');
      computePoints();
      if(onClickExtra) onClickExtra();
    });
    const preVal = (document.getElementById(prefix+'Hidden')?.value || "");
    if(preVal && preVal.includes(key)) pill.classList.add('active');
    wrap.appendChild(pill);
  });
}

buildPills(pericias, 'periciasWrap', 'pericias');
buildPills(vantagens, 'vantagensWrap', 'vantagens');
buildPills(desvantagens, 'desvWrap', 'desvantagens');

function computePoints(){
  const initial = parseInt(document.getElementById('initialPoints').value) || 0;
  const P = parseInt(document.getElementById('attrP')?.value) || 0;
  const H = parseInt(document.getElementById('attrH')?.value) || 0;
  const R = parseInt(document.getElementById('attrR')?.value) || 0;

  const atributosCost = P + H + R;

  const perCost = document.querySelectorAll('#periciasWrap .pill.active').length * 1;
  document.getElementById('periciasCost').textContent = perCost;
  
  let vantCost = 0;
  document.querySelectorAll('#vantagensWrap .pill.active').forEach(p=>{
    const key = p.dataset.key;
    const found = (vantagens.find(x=>x.k===key) || {c:1});
    vantCost += found.c || 1;
  });
  document.getElementById('vantCost').textContent = vantCost;
  
  let desvGain = 0;
  document.querySelectorAll('#desvWrap .pill.active').forEach(p=>{
    const key = p.dataset.key;
    const found = (desvantagens.find(x=>x.k===key) || {g:1});
    desvGain += found.g || 1;
  });
  document.getElementById('desvGain').textContent = desvGain;

  const left = initial - (atributosCost + perCost + vantCost - desvGain);
  document.getElementById('pointsLeft').textContent = left;
}

document.getElementById('initialPoints').addEventListener('input', computePoints);
computePoints();

function prepareSubmit(){
  const selPer = Array.from(document.querySelectorAll('#periciasWrap .pill.active')).map(p=>p.dataset.key);
  document.getElementById('periciasHidden').value = selPer.join(', ');

  const selV = Array.from(document.querySelectorAll('#vantagensWrap .pill.active')).map(p=>p.dataset.key);
  document.getElementById('vantagensHidden').value = selV.join(', ');

  const selD = Array.from(document.querySelectorAll('#desvWrap .pill.active')).map(p=>p.dataset.key);
  document.getElementById('desvantagensHidden').value = selD.join(', ');

  computePoints();
  if(confirm("Salvar ficha?\nPontos restantes: " + document.getElementById('pointsLeft').textContent)){
    document.getElementById('finalForm').submit();
  }
}
  
function resetSelections(){
  document.querySelectorAll('.pill').forEach(p=>
    p.classList.remove('active')
  );
  document.getElementById('periciasHidden').value = '';
  document.getElementById('vantagensHidden').value = '';
  document.getElementById('desvantagensHidden').value = '';
  
  ['attrP','attrH','attrR'].forEach(id => {
  document.getElementById(id).addEventListener('input', computePoints);
});

   computePoints();
}
</script>
</body>
</html>
